name: Weekly Health Check

on:
  schedule:
    - cron: '0 10 * * 1'

  workflow_dispatch:

permissions:
  contents: read
  issues: write

jobs:
  health-check:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Run health check
        id: health
        continue-on-error: true
        run: |
          chmod +x scripts/health-check.sh
          ./scripts/health-check.sh > health-report.txt 2>&1
          EXIT_CODE=$?
          echo "exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT

          SUCCESS_COUNT=$(grep -c "✅" health-report.txt || echo "0")
          WARNING_COUNT=$(grep -c "⚠️" health-report.txt || echo "0")
          ERROR_COUNT=$(grep -c "❌" health-report.txt || echo "0")

          echo "success_count=$SUCCESS_COUNT" >> $GITHUB_OUTPUT
          echo "warning_count=$WARNING_COUNT" >> $GITHUB_OUTPUT
          echo "error_count=$ERROR_COUNT" >> $GITHUB_OUTPUT

          if [ $EXIT_CODE -eq 0 ]; then
            echo "status=HEALTHY" >> $GITHUB_OUTPUT
            echo "status_emoji=✅" >> $GITHUB_OUTPUT
          elif [ $ERROR_COUNT -eq 0 ]; then
            echo "status=WARNINGS" >> $GITHUB_OUTPUT
            echo "status_emoji=⚠️" >> $GITHUB_OUTPUT
          else
            echo "status=ERRORS" >> $GITHUB_OUTPUT
            echo "status_emoji=❌" >> $GITHUB_OUTPUT
          fi

          cat health-report.txt
          exit 0

      - name: Generate detailed report if issues found
        if: steps.health.outputs.exit_code != '0'
        run: |
          chmod +x scripts/sync-check-advanced.sh
          echo "Running detailed sync analysis..."
          ./scripts/sync-check-advanced.sh --report > detailed-report.txt 2>&1 || true
          cat detailed-report.txt

      - name: Upload reports as artifacts
        uses: actions/upload-artifact@v4
        with:
          name: weekly-health-report-${{ github.run_number }}
          path: |
            health-report.txt
            detailed-report.txt
            reports/
          retention-days: 90

      - name: Create issue if critical errors found
        if: steps.health.outputs.status == 'ERRORS'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('health-report.txt', 'utf8');
            const date = new Date().toISOString().split('T')[0];

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'Weekly Health Check Failed - ' + date,
              body: 'Critical errors detected in weekly health check.\n\n## Summary\n- Errors: ${{ steps.health.outputs.error_count }}\n- Warnings: ${{ steps.health.outputs.warning_count }}\n\n## Health Check Output\n```\n' + report.substring(0, 5000) + '\n```\n\n## Immediate Actions Required\n1. Review the full report\n2. Run detailed analysis: `./scripts/sync-check-advanced.sh`\n3. Consult remediation workflows\n4. Fix issues before next development session',
              labels: ['health-check', 'critical', 'needs-attention', 'automated']
            });

      - name: Post summary
        run: |
          echo "### Weekly Health Check Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ${{ steps.health.outputs.status_emoji }} ${{ steps.health.outputs.status }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Success | ${{ steps.health.outputs.success_count }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Warnings | ${{ steps.health.outputs.warning_count }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Errors | ${{ steps.health.outputs.error_count }} |" >> $GITHUB_STEP_SUMMARY
