name: Auto-Sync Submodules

on:
  repository_dispatch:
    types: [edition-updated]

  workflow_dispatch:
    inputs:
      edition:
        description: 'Edition name (claude, bmad, spec-kit, etc.)'
        required: true
        type: string

permissions:
  contents: write
  issues: write

jobs:
  sync-submodule:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout parent repo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          submodules: recursive

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Update submodule to latest
        id: update
        run: |
          EDITION="${{ github.event.client_payload.edition || github.event.inputs.edition }}"
          echo "Updating submodule: versions/$EDITION"
          echo "edition=$EDITION" >> $GITHUB_OUTPUT

          cd "versions/$EDITION"
          git fetch origin
          git checkout origin/main
          cd ../..

          if git diff --quiet HEAD; then
            echo "No changes to commit"
            echo "has_changes=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "has_changes=true" >> $GITHUB_OUTPUT
          SUBMODULE_COMMIT=$(git -C "versions/$EDITION" log -1 --format='%h - %s')
          echo "submodule_commit=$SUBMODULE_COMMIT" >> $GITHUB_OUTPUT

      - name: Commit and push changes
        if: steps.update.outputs.has_changes == 'true'
        run: |
          EDITION="${{ steps.update.outputs.edition }}"
          SUBMODULE_COMMIT="${{ steps.update.outputs.submodule_commit }}"

          git add "versions/$EDITION"
          git commit -m "chore: auto-update $EDITION submodule to latest"
          git push origin main

      - name: Run health check
        id: health_check
        if: steps.update.outputs.has_changes == 'true'
        continue-on-error: true
        run: |
          chmod +x scripts/health-check.sh
          ./scripts/health-check.sh > health-check-output.txt 2>&1
          EXIT_CODE=$?
          echo "exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT
          cat health-check-output.txt
          exit $EXIT_CODE

      - name: Create issue if health check fails
        if: steps.update.outputs.has_changes == 'true' && steps.health_check.outputs.exit_code != '0'
        uses: actions/github-script@v7
        with:
          script: |
            const edition = '${{ steps.update.outputs.edition }}';
            const commit = '${{ steps.update.outputs.submodule_commit }}';
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'Health Check Failed After Auto-Sync: ' + edition,
              body: 'Automated submodule sync completed for **' + edition + '** but health check failed.\n\n**Submodule Update:** ' + commit + '\n\nPlease review the workflow run and resolve any sync issues.',
              labels: ['automation', 'health-check', 'needs-attention']
            });

      - name: Log success
        if: steps.update.outputs.has_changes == 'true' && steps.health_check.outputs.exit_code == '0'
        run: |
          echo "Auto-sync completed successfully for ${{ steps.update.outputs.edition }}"
          echo "Health check passed"
